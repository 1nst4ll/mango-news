---
import BaseLayout from '/src/layouts/BaseLayout.astro';
import SundayEditionDetail from '/src/components/SundayEditionDetail.tsx';
import { marked } from 'marked';

export const prerender = true;

export async function getStaticPaths() {
  const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';
  let sundayEditions = [];
  try {
      const response = await fetch(`${apiUrl}/api/sunday-editions`);
      if (response.ok) {
        const data = await response.json();
        sundayEditions = data; // Assuming the API returns the array directly
      }
  } catch (error) {
    console.error('Error fetching Sunday Editions for static paths:', error);
  }

  const languages = ['en', 'es', 'ht']; // Define supported languages

  return sundayEditions.flatMap(edition => {
    return languages.map(lang => ({
      params: { lang, id: edition.id.toString() },
    }));
  });
}

const { lang, id } = Astro.params;

let edition = null;
try {
  const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';
  const response = await fetch(`${apiUrl}/api/sunday-editions/${id}`);
  if (response.ok) {
    edition = await response.json();
  }
} catch (error) {
  console.error(`Error fetching Sunday Edition ${id}:`, error);
}

const displaySummary = edition ? marked.parse(edition.summary) : '';
---

<BaseLayout title={edition ? edition.title : 'Sunday Edition'} ogImageUrl={edition?.image_url}>
  {edition ? (
    <SundayEditionDetail edition={edition} lang={lang} client:load />
  ) : (
    <div class="text-center py-10">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Sunday Edition Not Found</h1>
      <p class="text-gray-600 dark:text-gray-400">The requested Sunday Edition could not be found.</p>
    </div>
  )}
</BaseLayout>
