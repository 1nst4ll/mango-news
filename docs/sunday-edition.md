# Sunday Edition Feature

This document describes the "Sunday Edition" feature, which provides a weekly summary of news articles with AI-generated narration and imagery.

## Overview

The Sunday Edition is a special post generated automatically every Sunday morning. It aggregates summaries of all articles published during the preceding week, sends them to an LLM to create a CNN news anchor-style summary (up to 2900 characters), and then uses the Unreal Speech API to generate an audio narration of this summary. Each Sunday Edition post includes:

*   A generated title (e.g., "Mango News Sunday Edition - Month Day, Year").
*   An AI-generated summary of the week's news.
*   An audio narration of the summary, read by the "Daniel" voice.
*   An AI-generated image relevant to the week's news in Turks and Caicos.

## Technical Implementation

### Backend

The backend handles the generation, storage, and serving of Sunday Edition posts.

#### Database Schema

A new table, `sunday_editions`, has been added to the PostgreSQL database:

```sql
CREATE TABLE sunday_editions (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    summary TEXT,
    narration_url TEXT,
    image_url TEXT,
    publication_date TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

*   `title`: The title of the Sunday Edition post.
*   `summary`: The LLM-generated summary of the week's articles.
*   `narration_url`: The S3 URL of the audio file generated by the Unreal Speech API.
*   `image_url`: The S3 URL of the AI-generated image for the Sunday Edition.
*   `publication_date`: The date the Sunday Edition was published.
*   `created_at`: Timestamp of when the record was created.

#### New Service: `backend/src/sundayEditionGenerator.js`

This new module contains the core logic for generating a Sunday Edition:

*   `fetchWeeklyArticles()`: Queries the `articles` table for all articles published in the last 7 days.
*   `generateSundayEditionSummary(articles)`: Uses the Groq API to generate a CNN news anchor-style summary from the collected article content.
*   `generateNarration(summary)`: Sends the summary to the Unreal Speech API (using the "Daniel" voice), downloads the resulting audio, and uploads it to an AWS S3 bucket. The S3 URL is then stored.
*   `generateSundayEditionImage(summary)`: Reuses the existing `generateAIImage` function from `scraper.js` to create a relevant image, which is also uploaded to S3.
*   `createSundayEdition()`: Orchestrates the entire generation process, from fetching articles to saving the final post in the `sunday_editions` table.

#### API Endpoints

The following new API endpoints have been added to `backend/src/index.js`:

*   **`POST /api/sunday-editions/generate`**:
    *   **Description**: Manually triggers the generation of a new Sunday Edition post. Requires authentication.
    *   **Authentication**: Required.
    *   **Success Response**: `{ message: "Sunday Edition created successfully.", id: number }`
*   **`GET /api/sunday-editions`**:
    *   **Description**: Retrieves a paginated list of all Sunday Edition posts.
    *   **Authentication**: None required.
    *   **Query Parameters**: `page` (number), `limit` (number).
*   **`GET /api/sunday-editions/:id`**:
    *   **Description**: Retrieves details for a single Sunday Edition post by its ID.
    *   **Authentication**: None required.

#### Scheduled Job

A new cron job has been added in `backend/src/scraper.js` to automatically run the `createSundayEdition()` function every Sunday morning. The default schedule is `0 0 * * 0` (midnight on Sunday). This schedule can be configured via the `sunday_edition_frequency` setting in the `application_settings` table.

#### Environment Variables

The `UNREAL_SPEECH_API_KEY` environment variable must be set in your `.env` file for the Unreal Speech API integration to work.

### Frontend

The frontend has been updated to display Sunday Edition posts seamlessly within the news feed and on a dedicated page.

#### `frontend/src/components/ui/AudioPlayer.tsx`

A new reusable React component for playing audio files has been created.

#### `frontend/src/components/NewsFeed.tsx`

*   The `NewsFeed` component now fetches Sunday Edition posts in addition to regular articles.
*   It combines and sorts both types of content by publication date.
*   Sunday Edition posts are rendered with a distinct card design that includes the `AudioPlayer` component for narration playback.
*   Sharing options (WhatsApp, Facebook) are available for Sunday Edition posts, linking to their dedicated pages.

#### `frontend/src/pages/[lang]/sunday-edition/[id].astro`

A new Astro page has been created to display the full content of a single Sunday Edition post. This page includes:

*   The AI-generated image.
*   The title and publication date.
*   The `AudioPlayer` for narration.
*   The full summary text.

#### Translation Updates

The `sunday_edition` key has been added to the translation files (`en.json`, `es.json`, `ht.json`) to support multilingual display of the "Sunday Edition" label.

## Setup and Configuration

1.  **Database Migration**: Ensure the `add_sunday_editions_table.sql` migration is applied to your PostgreSQL database.
2.  **Environment Variable**: Add `UNREAL_SPEECH_API_KEY=your_unreal_speech_api_key` to your `backend/.env` file.
3.  **Restart Backend**: Restart your backend server to ensure all new code and scheduled jobs are loaded.
4.  **Frontend Build**: Rebuild your frontend application to include the new components and pages.

## Usage

Once configured, Sunday Editions will be automatically generated and added to your news feed every Sunday. You can also manually trigger the generation via the `POST /api/sunday-editions/generate` API endpoint (requires authentication).
